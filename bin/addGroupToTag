#!/usr/bin/php
<?php
$rootDir = dirname(__FILE__) . '/../';

include $rootDir . '/vendor/api-php/OpenPhotoOAuth.php';
include $rootDir . '/src/syncLogger.class.php';
include $rootDir . '/src/OpenPhotoOAuthFactory.class.php';
include $rootDir . '/src/functions.php';
include $rootDir . '/config/defaults.php';

$oAuthFactory = new OpenPhotoOAuthFactory();
$client       = $oAuthFactory->create($config);
$logger       = new syncLogger();
$tag          = $argv[1];
$tagsAdd      = $argv[2];
$hashs        = getHashs($client, $logger, $tag);
$total        = count($hashs);
$cpt          = 0;
$updated      = 0;

$logger->log(sprintf('%s photos tagged with "%s"', count($hashs), $tag));

foreach (array_keys($hashs) as $idPhoto)
{
  $cpt++;
  $position  = sprintf('[%s/%s]', str_pad($cpt,strlen($total), '0', STR_PAD_LEFT), $total);
  $response  = $client->post(sprintf("/photo/%s/update.json", $idPhoto), array('groups' => $tagsAdd));
  $dResponse = json_decode($response);
  $logger->log(sprintf('%s Updating photo "%s"...', $position, $idPhoto));
  if (false !== $dResponse)
  {
    if (false === $dResponse->result)
    {
      $logger->log(sprintf('%s [error] Error updating photo', $position));
      continue;
    }
  }
  $updated++;
  $logger->log(sprintf('%s Group(s) "%s" added to photo "%s"', $position, $tagsAdd, $idPhoto));
}
 $logger->log(sprintf('%s photos updated', $cpt++));

