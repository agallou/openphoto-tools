#!/usr/bin/php
<?php
$rootDir = dirname(__FILE__) . '/../';

include $rootDir . '/vendor/api-php/OpenPhotoOAuth.php';
include $rootDir . '/src/syncLogger.class.php';
include $rootDir . '/src/OpenPhotoOAuthFactory.class.php';
include $rootDir . '/src/functions.php';
include $rootDir . '/config/defaults.php';

$dir          = $argv[1];
$oAuthFactory = new OpenPhotoOAuthFactory();
$client       = $oAuthFactory->create($config);
$logger       = new syncLogger();

ini_set('memory_limit', '1G');

$hashs = getHashs($client, $logger);
$paths = getPaths($dir);
$cpt   = 0;

$logger->log(sprintf('%s photos on openphoto', count($hashs)));

$logger->setTotal(count($paths));
foreach ($paths as $pathName)
{
  $cpt++;
  $logger->setPosition($cpt);
  uploadFile($client, $logger, $config['exiftran'], $hashs, $pathName);
}
$logger->setTotal(null);

$newHashs = getHashs($client, $logger);
$logger->log(sprintf('%s photos added', count($newHashs) - count($hashs)));
$logger->log(sprintf('%s photos now on openphoto', count($hashs)));
